name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
          # Step 1: Checkout the code
          - name: Checkout code
            uses: actions/checkout@v3
    
          # Step 2: Set up Node.js
          - name: Set up Node.js
            uses: actions/setup-node@v3
            with:
              node-version: '18'
    
          # Step 3: Generate environment files from GitHub Secrets
          - name: Generate .env.backend file
            run: |
              mkdir -p ./config/environment-variables
              echo "# TimeZone" > ./config/environment-variables/.env.backend.prod
              echo "TZ=${{ secrets.TZ }}" >> ./config/environment-variables/.env.backend.prod
              echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> ./config/environment-variables/.env.backend.prod
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> ./config/environment-variables/.env.backend.prod
              echo "ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}" >> ./config/environment-variables/.env.backend.prod
              echo "REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}" >> ./config/environment-variables/.env.backend.prod
    
          - name: Generate .env.db file
            run: |
              echo "# POSTGRES" > ./config/environment-variables/.env.db.prod
              echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> ./config/environment-variables/.env.db.prod
              echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> ./config/environment-variables/.env.db.prod
              echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> ./config/environment-variables/.env.db.prod
    
          # Step 4: Install dependencies
          - name: Install dependencies
            run: npm install
    
          # Step 5: Build the application
          - name: Build application
            run: npm run build:dev
    
          # Step 6: Start the application
          - name: Start application
            run: npm run dev &
            env:
              TZ: ${{ secrets.TZ }}
              NODE_ENV: ${{ secrets.NODE_ENV }}
              DATABASE_URL: ${{ secrets.DATABASE_URL }}
              ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
              REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET }}
    
          # Step 7: Seed the database (if first deployment)
          - name: Seed database
            if: ${{ steps.check-first-run.outputs.first_run == 'true' }}
            run: npm run seed
            env:
              TZ: ${{ secrets.TZ }}
              NODE_ENV: ${{ secrets.NODE_ENV }}
              DATABASE_URL: ${{ secrets.DATABASE_URL }}
              POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
              POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
              POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
    
          # Step 8: Check for first deployment
          - name: Check for first deployment
            id: check-first-run
            run: |
              if [[ ! -f /app/.deployed ]]; then
                echo "first_run=true" >> $GITHUB_ENV
              else
                echo "first_run=false" >> $GITHUB_ENV
    
          # Step 9: Mark deployment as complete
          - name: Mark as deployed
            run: touch /app/.deployed
